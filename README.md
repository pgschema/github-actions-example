# pgschema GitHub Actions Example

This repository demonstrates how to use [pgschema](https://www.pgschema.com/) with GitHub Actions to automatically run schema migration plans on pull requests. It includes examples for both single-file and multi-file schema approaches.

## Overview

### Plan Workflows (Pull Requests)

- **Single File Plan** - Shows migration plan for single-file schemas
- **Multi File Plan** - Shows migration plan for multi-file schemas

Plan workflows automatically:

- Run `pgschema plan` when a PR modifies schema files
- Post the migration plan as a comment on the PR
- Update the comment if the PR is synchronized with new changes

### Apply Workflows (Main Branch)

- **Single File Apply** - Applies schema changes for single-file approach
- **Multi File Apply** - Applies schema changes for multi-file approach

Apply workflows automatically:

- Run `pgschema apply` when changes are pushed to main branch
- Use `--auto-approve` flag for automated deployment
- Apply changes to a test PostgreSQL 17 container
- Report success or failure with detailed logs

## Setup

### GitHub Secrets

No secrets required! Both workflows start a PostgreSQL 17 test container for demonstration purposes, making them fully self-contained.

### Schema Organization

#### Single File Approach

- Place your complete schema in `singlefile/schema.sql`. This is generated by `pgschema dump --host localhost --user postgres --password testpwd1 --db employee --file schema.sql`.
- All tables, indexes, functions, and triggers in one file
- Plan workflow: `.github/workflows/pgschema-singlefile-plan.yml`
- Apply workflow: `.github/workflows/pgschema-singlefile-apply.yml`

#### Multi File Approach

- Place SQL files in the `multifile/` directory. This is generated by `pgschema dump --host localhost --user postgres --password testpwd1 --db employee --multi-file --file main.sql`
- Uses `main.sql` as the entry point with psql `\i` directives
- Organize files by type in subdirectories (tables/, functions/, views/, etc.). Each file contains a specific database object
- Plan workflow: `.github/workflows/pgschema-multifile-plan.yml`
- Apply workflow: `.github/workflows/pgschema-multifile-apply.yml`

For more information, visit the [pgschema documentation](https://www.pgschema.com/).
